<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AFZ Database - Agriculture Freedom Zones Viewer</title>

    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary-color: #2c5f2d;
            --secondary-color: #97bc62;
            --accent-color: #ffa500;
            --danger-color: #d32f2f;
            --text-dark: #1a1a1a;
            --text-light: #666;
            --bg-light: #f5f5f5;
            --border-color: #ddd;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: var(--text-dark);
            min-height: 100vh;
        }

        .container {
            max-width: 100%;
            margin: 0 auto;
            padding: 20px;
        }

        header {
            background: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        h1 {
            color: var(--primary-color);
            font-size: 2rem;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .subtitle {
            color: var(--text-light);
            font-size: 0.95rem;
            margin-bottom: 15px;
        }

        .info-banner {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 10px;
        }

        .info-banner h3 {
            margin-bottom: 8px;
            font-size: 1.1rem;
        }

        .info-banner ul {
            list-style: none;
            padding-left: 0;
        }

        .info-banner li {
            padding: 4px 0;
            padding-left: 20px;
            position: relative;
        }

        .info-banner li:before {
            content: "‚úì";
            position: absolute;
            left: 0;
            font-weight: bold;
        }

        .controls {
            background: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .controls-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin-bottom: 15px;
        }

        .control-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .control-group label {
            font-weight: 600;
            color: var(--text-dark);
            font-size: 0.9rem;
        }

        select, input {
            padding: 10px;
            border: 2px solid var(--border-color);
            border-radius: 6px;
            font-size: 0.95rem;
            transition: border-color 0.3s;
        }

        select:focus, input:focus {
            outline: none;
            border-color: var(--primary-color);
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }

        .stat-card {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
        }

        .stat-value {
            font-size: 2rem;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 0.85rem;
            opacity: 0.9;
        }

        #map {
            height: 600px;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }

        .parcels-table-container {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            overflow-x: auto;
        }

        .parcels-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }

        .parcels-table th {
            background: var(--primary-color);
            color: white;
            padding: 12px;
            text-align: left;
            font-weight: 600;
            position: sticky;
            top: 0;
        }

        .parcels-table td {
            padding: 12px;
            border-bottom: 1px solid var(--border-color);
        }

        .parcels-table tbody tr:hover {
            background: #f9f9f9;
            cursor: pointer;
        }

        .score-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-weight: bold;
            font-size: 0.85rem;
        }

        .score-high {
            background: #4caf50;
            color: white;
        }

        .score-medium {
            background: #ff9800;
            color: white;
        }

        .score-low {
            background: #9e9e9e;
            color: white;
        }

        .criteria-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
        }

        .criteria-tag {
            display: inline-block;
            padding: 3px 10px;
            border-radius: 4px;
            font-size: 0.8rem;
            font-weight: 500;
        }

        .tag-marginal {
            background: #fff3e0;
            color: #e65100;
        }

        .tag-brownfield {
            background: #e8f5e9;
            color: #2e7d32;
        }

        .tag-arid {
            background: #fce4ec;
            color: #c2185b;
        }

        .tag-grid {
            background: #e3f2fd;
            color: #1565c0;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 0.95rem;
        }

        .btn-primary {
            background: var(--primary-color);
            color: white;
        }

        .btn-primary:hover {
            background: #1e4620;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }

        .btn-secondary {
            background: var(--secondary-color);
            color: white;
        }

        .export-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-top: 15px;
        }

        .loading {
            text-align: center;
            padding: 40px;
            font-size: 1.2rem;
            color: var(--primary-color);
        }

        .legend {
            background: white;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .legend h3 {
            margin-bottom: 10px;
            color: var(--primary-color);
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 10px;
            margin: 5px 0;
        }

        .legend-marker {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            border: 2px solid white;
            box-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }

        .back-link {
            display: inline-block;
            margin-top: 15px;
            color: var(--primary-color);
            text-decoration: none;
            font-weight: 600;
            transition: color 0.3s;
        }

        .back-link:hover {
            color: var(--secondary-color);
        }

        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }

            h1 {
                font-size: 1.5rem;
            }

            #map {
                height: 400px;
            }

            .controls-grid {
                grid-template-columns: 1fr;
            }

            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        .hidden {
            display: none !important;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>
                <span>üåæ</span>
                Agriculture Freedom Zones (AFZ) Database
            </h1>
            <p class="subtitle">
                Interactive database of AFZ-eligible lands across Texas
            </p>

            <div class="info-banner">
                <h3>AFZ Qualification Criteria:</h3>
                <ul>
                    <li><strong>Marginal Land:</strong> Poor soil quality, rocky terrain, steep slopes, or limited agricultural value</li>
                    <li><strong>Brownfield Sites:</strong> Remediated former industrial properties ready for redevelopment</li>
                    <li><strong>Arid Regions:</strong> Areas receiving less than 20 inches of rainfall annually</li>
                    <li><strong>Grid Access:</strong> Sites within 5 miles of substations or transmission lines</li>
                </ul>
            </div>

            <a href="index.html" class="back-link">‚Üê Back to Field Tool</a>
        </header>

        <div class="controls">
            <h2 style="margin-bottom: 15px;">Filters & Search</h2>

            <div class="controls-grid">
                <div class="control-group">
                    <label for="criteriaFilter">AFZ Criteria:</label>
                    <select id="criteriaFilter">
                        <option value="all">All Parcels</option>
                        <option value="Marginal Land">Marginal Land</option>
                        <option value="Brownfield Site">Brownfield Sites</option>
                        <option value="Arid Region">Arid Regions</option>
                        <option value="Grid Access">Grid Access</option>
                    </select>
                </div>

                <div class="control-group">
                    <label for="countyFilter">County:</label>
                    <select id="countyFilter">
                        <option value="all">All Counties</option>
                    </select>
                </div>

                <div class="control-group">
                    <label for="minAcres">Minimum Acres:</label>
                    <input type="number" id="minAcres" value="0" min="0" step="10">
                </div>

                <div class="control-group">
                    <label for="minScore">Minimum AFZ Score:</label>
                    <input type="number" id="minScore" value="30" min="0" max="100" step="5">
                </div>
            </div>

            <div class="stats-grid" id="statsGrid">
                <!-- Stats will be populated by JavaScript -->
            </div>

            <div class="export-buttons">
                <button class="btn btn-primary" onclick="exportToCSV()">üì• Export to CSV</button>
                <button class="btn btn-secondary" onclick="exportToJSON()">üì• Export to JSON</button>
            </div>
        </div>

        <div class="legend">
            <h3>Map Legend</h3>
            <div class="legend-item">
                <div class="legend-marker" style="background: #4caf50;"></div>
                <span><strong>High Score (80-100):</strong> Excellent AFZ candidate</span>
            </div>
            <div class="legend-item">
                <div class="legend-marker" style="background: #ff9800;"></div>
                <span><strong>Medium Score (50-79):</strong> Good AFZ candidate</span>
            </div>
            <div class="legend-item">
                <div class="legend-marker" style="background: #9e9e9e;"></div>
                <span><strong>Low Score (30-49):</strong> Marginal AFZ candidate</span>
            </div>
        </div>

        <div id="map"></div>

        <div class="parcels-table-container">
            <h2>AFZ-Eligible Parcels</h2>
            <div id="tableLoading" class="loading">Loading parcels...</div>
            <table class="parcels-table" id="parcelsTable" style="display: none;">
                <thead>
                    <tr>
                        <th>Parcel ID</th>
                        <th>Name</th>
                        <th>County</th>
                        <th>Acres</th>
                        <th>Score</th>
                        <th>AFZ Criteria</th>
                        <th>Grid Access</th>
                    </tr>
                </thead>
                <tbody id="parcelsTableBody">
                </tbody>
            </table>
        </div>
    </div>

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <script>
        let afzData = null;
        let map = null;
        let markers = [];
        let allParcels = [];

        // Initialize map
        function initMap() {
            map = L.map('map').setView([31.5, -99.5], 6);

            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '¬© OpenStreetMap contributors',
                maxZoom: 18
            }).addTo(map);
        }

        // Load AFZ data
        async function loadAFZData() {
            try {
                const response = await fetch('data/afz_parcels.json');
                afzData = await response.json();
                allParcels = afzData.parcels;

                populateCountyFilter();
                updateStatistics();
                displayParcels(allParcels);

                document.getElementById('tableLoading').style.display = 'none';
                document.getElementById('parcelsTable').style.display = 'table';
            } catch (error) {
                console.error('Error loading AFZ data:', error);
                document.getElementById('tableLoading').innerHTML =
                    '<p style="color: red;">Error loading AFZ data. Please ensure data/afz_parcels.json exists.</p>';
            }
        }

        // Populate county filter dropdown
        function populateCountyFilter() {
            const counties = [...new Set(allParcels.map(p => p.county))].sort();
            const select = document.getElementById('countyFilter');

            counties.forEach(county => {
                const option = document.createElement('option');
                option.value = county;
                option.textContent = county;
                select.appendChild(option);
            });
        }

        // Update statistics
        function updateStatistics(parcels = allParcels) {
            const totalAcres = parcels.reduce((sum, p) => sum + p.acres, 0);
            const avgScore = parcels.length > 0 ?
                parcels.reduce((sum, p) => sum + p.score, 0) / parcels.length : 0;

            const brownfields = parcels.filter(p => p.is_brownfield).length;
            const aridRegions = parcels.filter(p => p.is_arid).length;
            const gridAccess = parcels.filter(p => p.has_grid_access).length;

            const statsHTML = `
                <div class="stat-card">
                    <div class="stat-value">${parcels.length}</div>
                    <div class="stat-label">Total Parcels</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${totalAcres.toLocaleString()}</div>
                    <div class="stat-label">Total Acres</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${avgScore.toFixed(0)}</div>
                    <div class="stat-label">Avg Score</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${brownfields}</div>
                    <div class="stat-label">Brownfields</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${aridRegions}</div>
                    <div class="stat-label">Arid Regions</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${gridAccess}</div>
                    <div class="stat-label">Grid Access</div>
                </div>
            `;

            document.getElementById('statsGrid').innerHTML = statsHTML;
        }

        // Get marker color based on score
        function getMarkerColor(score) {
            if (score >= 80) return '#4caf50'; // Green
            if (score >= 50) return '#ff9800'; // Orange
            return '#9e9e9e'; // Gray
        }

        // Display parcels on map and table
        function displayParcels(parcels) {
            // Clear existing markers
            markers.forEach(marker => map.removeLayer(marker));
            markers = [];

            // Add markers to map
            parcels.forEach(parcel => {
                const color = getMarkerColor(parcel.score);

                const marker = L.circleMarker([parcel.latitude, parcel.longitude], {
                    radius: 8,
                    fillColor: color,
                    color: 'white',
                    weight: 2,
                    opacity: 1,
                    fillOpacity: 0.8
                }).addTo(map);

                const popupContent = `
                    <strong>${parcel.name}</strong><br>
                    <strong>ID:</strong> ${parcel.id}<br>
                    <strong>County:</strong> ${parcel.county}<br>
                    <strong>Acres:</strong> ${parcel.acres.toLocaleString()}<br>
                    <strong>AFZ Score:</strong> ${parcel.score}/100<br>
                    <strong>Criteria:</strong> ${parcel.afz_criteria.join(', ')}<br>
                    <strong>Soil Quality:</strong> ${parcel.soil_quality}<br>
                    <strong>Rainfall:</strong> ${parcel.avg_rainfall_inches}" annually<br>
                    <strong>Nearest Substation:</strong> ${parcel.nearest_substation_miles} mi<br>
                    ${parcel.notes ? `<strong>Notes:</strong> ${parcel.notes}` : ''}
                `;

                marker.bindPopup(popupContent);
                markers.push(marker);
            });

            // Update table
            updateTable(parcels);
        }

        // Update parcels table
        function updateTable(parcels) {
            const tbody = document.getElementById('parcelsTableBody');
            tbody.innerHTML = '';

            parcels.forEach(parcel => {
                const row = tbody.insertRow();
                row.onclick = () => {
                    map.setView([parcel.latitude, parcel.longitude], 12);
                    markers.find(m =>
                        m.getLatLng().lat === parcel.latitude &&
                        m.getLatLng().lng === parcel.longitude
                    )?.openPopup();
                };

                const scoreClass = parcel.score >= 80 ? 'score-high' :
                                   parcel.score >= 50 ? 'score-medium' : 'score-low';

                const criteriaHTML = parcel.afz_criteria.map(c => {
                    const tagClass = c === 'Marginal Land' ? 'tag-marginal' :
                                    c === 'Brownfield Site' ? 'tag-brownfield' :
                                    c === 'Arid Region' ? 'tag-arid' : 'tag-grid';
                    return `<span class="criteria-tag ${tagClass}">${c}</span>`;
                }).join(' ');

                row.innerHTML = `
                    <td>${parcel.id}</td>
                    <td>${parcel.name}</td>
                    <td>${parcel.county}</td>
                    <td>${parcel.acres.toLocaleString()}</td>
                    <td><span class="score-badge ${scoreClass}">${parcel.score}</span></td>
                    <td><div class="criteria-tags">${criteriaHTML}</div></td>
                    <td>${parcel.has_grid_access ? '‚úì Yes' : '‚úó No'}</td>
                `;
            });
        }

        // Apply filters
        function applyFilters() {
            const criteria = document.getElementById('criteriaFilter').value;
            const county = document.getElementById('countyFilter').value;
            const minAcres = parseFloat(document.getElementById('minAcres').value) || 0;
            const minScore = parseFloat(document.getElementById('minScore').value) || 0;

            let filtered = allParcels.filter(parcel => {
                if (criteria !== 'all' && !parcel.afz_criteria.includes(criteria)) {
                    return false;
                }
                if (county !== 'all' && parcel.county !== county) {
                    return false;
                }
                if (parcel.acres < minAcres) {
                    return false;
                }
                if (parcel.score < minScore) {
                    return false;
                }
                return true;
            });

            updateStatistics(filtered);
            displayParcels(filtered);
        }

        // Export to CSV
        function exportToCSV() {
            const headers = ['Parcel ID', 'Name', 'County', 'State', 'Latitude', 'Longitude',
                           'Acres', 'AFZ Score', 'Criteria', 'Soil Quality', 'Brownfield',
                           'Arid', 'Avg Rainfall', 'Nearest Substation (mi)', 'Grid Access',
                           'Current Use', 'Elevation (ft)', 'Notes'];

            const rows = allParcels.map(p => [
                p.id, p.name, p.county, p.state, p.latitude, p.longitude,
                p.acres, p.score, p.afz_criteria.join('; '), p.soil_quality,
                p.is_brownfield, p.is_arid, p.avg_rainfall_inches,
                p.nearest_substation_miles, p.has_grid_access, p.current_use,
                p.elevation_ft, p.notes
            ]);

            let csv = headers.join(',') + '\n';
            rows.forEach(row => {
                csv += row.map(cell => `"${cell}"`).join(',') + '\n';
            });

            downloadFile(csv, 'afz_parcels.csv', 'text/csv');
        }

        // Export to JSON
        function exportToJSON() {
            const json = JSON.stringify(afzData, null, 2);
            downloadFile(json, 'afz_parcels.json', 'application/json');
        }

        // Download file helper
        function downloadFile(content, filename, mimeType) {
            const blob = new Blob([content], { type: mimeType });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        // Event listeners
        document.getElementById('criteriaFilter').addEventListener('change', applyFilters);
        document.getElementById('countyFilter').addEventListener('change', applyFilters);
        document.getElementById('minAcres').addEventListener('input', applyFilters);
        document.getElementById('minScore').addEventListener('input', applyFilters);

        // Initialize on page load
        window.onload = function() {
            initMap();
            loadAFZData();
        };
    </script>
</body>
</html>
